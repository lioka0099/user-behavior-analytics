# Android SDK - Installation & Usage

This page documents the Android analytics SDK in `sdk/android/analytics-sdk/`.

The SDK is designed to be easy to integrate:

- Call `AnalyticsSDK.init(...)` once at app startup
- Call `AnalyticsSDK.track(...)` whenever something important happens
- Call `AnalyticsSDK.flush()` when the app goes to background (recommended)

## What the SDK sends

The SDK sends event batches to the backend ingestion endpoint:

- `POST /events`

Each batch includes:

- `api_key` (identifies the tracked app/project)
- `sent_at_ms` (client timestamp)
- `events[]` (each event has `event_name`, `timestamp_ms`, `session_id`, `platform`, `properties`)

## Installation (JitPack)

The SDK is published to JitPack as:

```kotlin
implementation("com.github.lioka0099:user-behavior-analytics:1.0.2")
```

### Make sure JitPack is enabled

In your root `settings.gradle(.kts)` or repository configuration, include JitPack:

```kotlin
repositories {
  maven("https://jitpack.io")
}
```

## Quick start

### 1) Initialize the SDK

Call `init()` once (for example in `Application.onCreate()` or your `MainActivity.onCreate()`).

```kotlin
import com.example.analytics.AnalyticsSDK

AnalyticsSDK.init(
  context = this,
  apiKey = "app_XXXXXXXX",
  endpoint = "https://user-behavior-analytics-production.up.railway.app/",
  flushThreshold = 0
)
```

Parameters:

- **`context`**: any Android `Context` (the SDK stores `applicationContext`)
- **`apiKey`**: the API key generated by the backend `/apps` endpoints (shown in the dashboard)
- **`endpoint`**: backend base URL
  - SDK will ensure it ends with `/`
- **`flushThreshold`**:
  - `0` = flush immediately after each `track()` call
  - `N > 0` = queue events and auto-flush when queue size reaches `N`

### 2) Track events

```kotlin
AnalyticsSDK.track("app_open", mapOf("source" to "direct"))
AnalyticsSDK.track("product_view", mapOf("product_id" to "sku_123"))
```

Rules:

- `eventName` must be non-empty
- `properties` should be JSON-friendly primitives (strings, numbers, booleans, null)

### 3) Flush events (recommended)

Flush when your app goes to background:

```kotlin
override fun onStop() {
  super.onStop()
  AnalyticsSDK.flush()
}
```

## Local development endpoint (Android emulator)

When running the backend on your computer at `http://localhost:8000`,
Android emulators access your host machine using:

- `http://10.0.2.2:8000/`

So your init looks like:

```kotlin
AnalyticsSDK.init(
  context = this,
  apiKey = "app_XXXXXXXX",
  endpoint = "http://10.0.2.2:8000/"
)
```

## Sessions

The SDK automatically creates a random session id at init.

You can access and manage the session:

```kotlin
val sessionId = AnalyticsSDK.getSessionId()
AnalyticsSDK.startNewSession()
```

## How the SDK behaves internally

Based on the current implementation:

- Events are queued in memory (`EventQueue`)
- On flush, the queue is drained and sent as a single batch
- Network calls use Retrofit with Gson
- The only ingestion endpoint is `POST /events`

Important implications:

- If the process is killed before flush, queued events may be lost
- If the network fails, the SDK currently logs the error (it does not retry/persist)

## Example: Demo app (ShopFlow)

The demo app (`demo-app/ShopFlow`) shows real usage. It configures:

- `ANALYTICS_API_KEY`
- `ANALYTICS_ENDPOINT`

in its `build.gradle.kts`, then calls:

```kotlin
AnalyticsSDK.init(
  context = this,
  apiKey = BuildConfig.ANALYTICS_API_KEY,
  endpoint = BuildConfig.ANALYTICS_ENDPOINT
)
```

## Troubleshooting

### “track() called but SDK not initialized”

You called `AnalyticsSDK.track(...)` before calling `AnalyticsSDK.init(...)`.
Initialize the SDK once at startup.

### Backend returns 404/405

Make sure your endpoint is the backend base URL and that it includes `/events` under it.

Examples:

- ✅ `endpoint = "https://...railway.app/"`
- ✅ `endpoint = "http://10.0.2.2:8000/"`
- ❌ `endpoint = "https://...railway.app/events"` (SDK already uses `/events`)

### Requests fail from a physical device

If you use a physical phone and a local backend:

- `10.0.2.2` only works on the emulator
- use your machine’s LAN IP instead (e.g. `http://192.168.1.10:8000/`)

### “No events tracked yet” in the dashboard

Checklist:

- Confirm the backend is reachable from the device/emulator
- Confirm you are using the correct `apiKey`
- Check Logcat for:
  - “SDK initialized…”
  - “Events sent successfully…”

