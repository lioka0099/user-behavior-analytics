# Architecture

This page explains how the project’s parts work together: **Android SDK → Backend API → Cloud DB → Dashboard**.

## System overview

### Components

- **Android SDK** (`sdk/android/analytics-sdk/`)
  - Developer-facing API: `init()`, `track()`, `flush()`, session helpers
  - Batches events and sends them to the backend
- **Backend API** (`backend/`)
  - FastAPI service with REST endpoints for event ingestion and analytics
  - Stores events and related data in the database
- **Database** (cloud Postgres via `DATABASE_URL`)
  - Stores events, funnel definitions, insights, and apps
- **Dashboard** (`dashboard/`)
  - Next.js admin portal
  - Uses Supabase Auth for authentication
  - Calls backend endpoints to manage apps and fetch analytics/insights

### Data flow (high level)

#### Diagram

<img
  src="/assets/DataFlowDiagram.png"
  alt="Data flow diagram (Android app -> SDK -> backend -> database -> dashboard)"
  width="900"
  style="max-width: 100%; height: auto;"
/>

## Architecture diagram (Mermaid)

This diagram focuses on **components**, **responsibilities**, and the two auth paths (**api_key** vs **Supabase JWT**).

#### Diagram

<img
  src="/assets/ArchitectureDiagram.png"
  alt="Architecture diagram (clients, dashboard, backend service, database, auth boundaries)"
  width="900"
  style="max-width: 100%; height: auto;"
/>


## Key ideas and responsibilities

### Event ingestion is “write-only”

Client apps **send** raw events to the backend. The platform is designed so that:

- SDKs only need one core endpoint: `POST /events`
- The dashboard can show analytics without exposing raw event payloads publicly

### Apps and API keys

Each tracked product/app has an **API key** generated by the backend. The API key is used by the SDK to associate events with the correct app/project.

Typical flow:

1. User signs into the dashboard (Supabase Auth).
2. User creates an “App” in the dashboard.
3. Backend generates an `api_key` (e.g. `app_xxxxxxxx`) for that App.
4. Developer copies that `api_key` into their Android app and initializes the SDK.

### Authentication model (important)

There are two different “auth concepts” in the system:

- **SDK ingestion auth**: uses **`api_key`** (sent inside the event batch body).
  - This is intentionally simple for client integration.
  - It should be treated as a secret (do not hardcode it into public repos).
- **Dashboard / app management auth**: uses **Supabase JWT Bearer tokens**.
  - The dashboard obtains a Supabase session.
  - It calls protected backend endpoints (like `/apps`) with `Authorization: Bearer <token>`.
  - Backend verifies the JWT and extracts `user_id`, then enforces ownership.

## Backend modules (how the code is structured)

- **Routers**: `backend/app/api/`
  - `events.py`: ingestion endpoint(s)
  - `analytics.py`: analytics + insights endpoints
  - `funnels.py`: funnel definition endpoints
  - `apps.py`: app CRUD (JWT-protected)
- **DB**: `backend/app/db/`
  - `database.py`: engine/session (`DATABASE_URL`)
  - `models.py`: SQLAlchemy tables (apps, events, funnel_definitions, insights)
- **Storage layer**: `backend/app/storage/`
  - Small functions that encapsulate DB reads/writes for specific tables
- **Analytics layer**: `backend/app/analytics/`
  - Funnel calculation, drop-off, path analysis, time-to-complete
- **Insights**: `backend/app/insights/`
  - Snapshot building + LLM prompt construction + insight generation

## Android SDK internals (what happens when you call `track`)

Typical sequence:

1. App calls `AnalyticsSDK.track("event_name", properties)`
2. SDK creates an `AnalyticsEvent` object with:
   - `event_name`
   - `timestamp_ms`
   - `session_id`
   - `platform = "android"`
   - `properties`
3. SDK pushes the event into an in-memory queue
4. SDK flushes immediately (or when threshold is reached)
5. On flush, SDK sends a JSON batch payload:

```json
{
  "api_key": "app_XXXXXXXX",
  "sent_at_ms": 1735368000999,
  "events": [
    {
      "event_name": "app_open",
      "timestamp_ms": 1735368000123,
      "session_id": "a4d9b8c2-7a1c-4d90-b92e-8c12f9a7d301",
      "platform": "android",
      "properties": { "source": "direct" }
    }
  ]
}
```

## Privacy & data handling

This project uses **anonymous session tracking**:

- Events are meant to contain **no PII** (no emails, names, phone numbers, etc.).
- Sessions are anonymous (random `session_id`).
- The “source of truth” for event shape and privacy rules is documented in:
  - `sdk-spec/` (and later mirrored into `docs/android-sdk/event-schema.md`)

## Deployment overview

The repository is structured for:

- **Backend**: deployed to Railway (see `railway.json`)
- **Dashboard**: deployed to Vercel
- **Database**: cloud Postgres configured via `DATABASE_URL`

